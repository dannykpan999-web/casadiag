{
  "permissions": {
    "allow": [
      "Bash(python optimize_media.py:*)",
      "Bash(npm uninstall:*)",
      "Bash(cat:*)",
      "Bash(python:*)",
      "Bash(npm install:*)",
      "Bash(npx prisma generate:*)",
      "Bash(npm run build:*)",
      "Bash(git init:*)",
      "Bash(git add:*)",
      "Bash(git remote add:*)",
      "Bash(git push:*)",
      "Bash(git commit:*)",
      "Bash(ssh root@91.98.167.120 \"systemctl status nginx\")",
      "Bash(ssh root@91.98.167.120 \"curl -I https://patologias.micasaverde.es\")",
      "Bash(ssh root@91.98.167.120 \"ls -la /var/www/casadiag/dist/\")",
      "Bash(ssh root@91.98.167.120 \"node --version 2>&1 || echo ''Node.js not installed''\")",
      "Bash(ssh root@91.98.167.120 \"apt update && apt install postgresql postgresql-contrib -y\")",
      "Bash(ssh root@91.98.167.120 \"systemctl start postgresql && systemctl enable postgresql && systemctl status postgresql | head -20\")",
      "Bash(ssh root@91.98.167.120 \"sudo -u postgres psql -c \"\"CREATE DATABASE casadiag;\"\" && sudo -u postgres psql -c \"\"CREATE USER casadiag_user WITH PASSWORD ''CasaDiag2026!Secure'';\"\" && sudo -u postgres psql -c \"\"GRANT ALL PRIVILEGES ON DATABASE casadiag TO casadiag_user;\"\" && sudo -u postgres psql -c \"\"ALTER DATABASE casadiag OWNER TO casadiag_user;\"\"\")",
      "Bash(ssh root@91.98.167.120 \"cd /var/www && git clone https://github.com/dannykpan999-web/casadiag-backend.git && ls -la casadiag-backend\")",
      "Bash(ssh root@91.98.167.120 \"npm install -g pm2\")",
      "Bash(ssh root@91.98.167.120 \"cd /var/www/casadiag-backend && npm install\")",
      "Bash(ssh root@91.98.167.120 \"df -h\")",
      "Bash(ssh root@91.98.167.120 \"du -sh /var/* | sort -h | tail -10\")",
      "Bash(ssh root@91.98.167.120 \"apt clean && apt autoclean && apt autoremove -y\")",
      "Bash(ssh root@91.98.167.120 \"rm -rf /root/.npm && journalctl --vacuum-size=50M && df -h /\")",
      "Bash(ssh root@91.98.167.120 \"cat > /var/www/casadiag-backend/.env << ''EOF''\nNODE_ENV=production\nPORT=3001\nAPP_URL=https://patologias.micasaverde.es\n\nDATABASE_URL=postgresql://casadiag_user:CasaDiag2026!Secure@localhost:5432/casadiag\n\nOPENAI_API_KEY=sk_V2_hgu_keRofxKWRnZ_qirqDbXQ3NxeHgGDPxqbYrMJ0mohpupu\nOPENAI_ASSISTANT_ID=asst_placeholder\n\nR2_ACCOUNT_ID=63c50c9ddb802085f72f311ae8e187cd\nR2_ACCESS_KEY_ID=0c9a54dc69bb1465e29e56121f0b71b6\nR2_SECRET_ACCESS_KEY=8d7d378894371b6769ab11ae0722145dd3926393310aa98a9f01c6903091db5f\nR2_BUCKET_NAME=casadiag-evidence\nR2_ENDPOINT=https://63c50c9ddb802085f72f311ae8e187cd.r2.cloudflarestorage.com\n\nSTRIPE_SECRET_KEY=sk_test_placeholder\nSTRIPE_WEBHOOK_SECRET=whsec_placeholder\n\nRESEND_API_KEY=re_placeholder\nEMAIL_FROM=noreply@micasaverde.es\n\nFRONTEND_URL=https://patologias.micasaverde.es\nEOF\ncat /var/www/casadiag-backend/.env\")",
      "Bash(ssh root@91.98.167.120 \"cd /var/www/casadiag-backend && npx prisma generate\")",
      "Bash(ssh root@91.98.167.120 \"cd /var/www/casadiag-backend && npx prisma migrate deploy\")",
      "Bash(ssh root@91.98.167.120 \"su - postgres -c \"\"psql -d casadiag -c ''GRANT ALL ON SCHEMA public TO casadiag_user;'' && psql -d casadiag -c ''GRANT CREATE ON SCHEMA public TO casadiag_user;''\"\"\")",
      "Bash(ssh root@91.98.167.120 \"su - postgres -c \"\"psql -c ''\\\\du casadiag_user''\"\"\")",
      "Bash(ssh root@91.98.167.120 \"cat /etc/postgresql/15/main/pg_hba.conf | grep -E ''^\\(local|host\\)''\")",
      "Bash(ssh root@91.98.167.120 \"sed -i ''s|@localhost:|@127.0.0.1:|g'' /var/www/casadiag-backend/.env && cat /var/www/casadiag-backend/.env | grep DATABASE_URL\")",
      "Bash(ssh root@91.98.167.120 \"sed -i ''s|CasaDiag2026!Secure|casadiag2026secure|g'' /var/www/casadiag-backend/.env && cat /var/www/casadiag-backend/.env | grep DATABASE_URL\")",
      "Bash(ssh root@91.98.167.120 \"cd /var/www/casadiag-backend && npx prisma migrate dev --name init\")",
      "Bash(ssh root@91.98.167.120 \"su - postgres -c \"\"psql -c ''ALTER USER casadiag_user CREATEDB;''\"\"\")",
      "Bash(ssh root@91.98.167.120 \"cd /var/www/casadiag-backend && pm2 start dist/main.js --name casadiag-api && pm2 save && pm2 startup | tail -1\")",
      "Bash(ssh root@91.98.167.120 \"pm2 logs casadiag-api --lines 20 --nostream\")",
      "Bash(ssh root@91.98.167.120 \"pm2 logs casadiag-api --lines 15 --nostream\")",
      "Bash(ssh root@91.98.167.120 \"pm2 delete casadiag-api && cd /var/www/casadiag-backend && pm2 start dist/main.js --name casadiag-api --env production && pm2 save\")",
      "Bash(ssh root@91.98.167.120 \"pm2 status && pm2 logs casadiag-api --lines 10 --nostream\")",
      "Bash(ssh root@91.98.167.120 \"pm2 logs casadiag-api --err --lines 40 --nostream | grep -A 20 ''Missing''\")",
      "Bash(ssh root@91.98.167.120 \"pm2 logs casadiag-api --err --lines 50 --nostream | head -60\")",
      "Bash(ssh root@91.98.167.120 \"cp /tmp/prisma-fix.ts /var/www/casadiag-backend/src/common/prisma.service.ts && cd /var/www/casadiag-backend && npm run build\")",
      "Bash(ssh root@91.98.167.120 \"cp /tmp/prisma-fix2.ts /var/www/casadiag-backend/src/common/prisma.service.ts && cd /var/www/casadiag-backend && npm run build\")",
      "Bash(ssh root@91.98.167.120 \"cat /var/www/casadiag-backend/prisma.config.ts\")",
      "Bash(ssh root@91.98.167.120 \"cat > /var/www/casadiag-backend/src/common/prisma.service.ts << ''EOF''\nimport { Injectable, OnModuleInit, OnModuleDestroy } from ''@nestjs/common'';\nimport { PrismaClient } from ''@prisma/client'';\n\n@Injectable\\(\\)\nexport class PrismaService extends PrismaClient implements OnModuleInit, OnModuleDestroy {\n  async onModuleInit\\(\\) {\n    await this.$connect\\(\\);\n    console.log\\(''✅ Database connected''\\);\n  }\n\n  async onModuleDestroy\\(\\) {\n    await this.$disconnect\\(\\);\n    console.log\\(''❌ Database disconnected''\\);\n  }\n}\nEOF\ncd /var/www/casadiag-backend && npm run build\")",
      "Bash(ssh root@91.98.167.120 \"pm2 delete casadiag-api && cd /var/www/casadiag-backend && NODE_ENV=production pm2 start dist/main.js --name casadiag-api --time && pm2 save\")",
      "Bash(ssh root@91.98.167.120 \"pm2 status && curl -s http://localhost:3001/api/cases || pm2 logs casadiag-api --lines 15 --nostream\")",
      "Bash(ssh root@91.98.167.120 \"cat > /var/www/casadiag-backend/ecosystem.config.js << ''EOF''\nmodule.require\\(''dotenv''\\).config\\(\\);\n\nmodule.exports = {\n  apps: [{\n    name: ''casadiag-api'',\n    script: ''./dist/main.js'',\n    instances: 1,\n    exec_mode: ''fork'',\n    env: {\n      NODE_ENV: ''production'',\n      PORT: 3001\n    },\n    env_file: ''.env'',\n    error_file: ''/root/.pm2/logs/casadiag-api-error.log'',\n    out_file: ''/root/.pm2/logs/casadiag-api-out.log'',\n    time: true,\n    autorestart: true,\n    watch: false,\n    max_restarts: 10,\n    min_uptime: ''10s''\n  }]\n};\nEOF\ncat /var/www/casadiag-backend/ecosystem.config.js\")",
      "Bash(ssh root@91.98.167.120 \"pm2 delete casadiag-api && cd /var/www/casadiag-backend && pm2 start ecosystem.config.js && pm2 save\")",
      "Bash(ssh root@91.98.167.120 \"pm2 status && curl -s http://localhost:3001/api/cases | head -20\")",
      "Bash(ssh root@91.98.167.120 \"pm2 logs casadiag-api --err --lines 30 --nostream | tail -40\")",
      "Bash(ssh root@91.98.167.120 \"cd /var/www/casadiag-backend && npm install prisma@5.22.0 @prisma/client@5.22.0 && npx prisma generate && npm run build\")",
      "Bash(ssh root@91.98.167.120 \"rm -rf /root/.npm /var/log/*.log /var/log/**/*.log /tmp/* && journalctl --vacuum-size=20M && df -h /\")",
      "Bash(ssh root@91.98.167.120 \"cd /var/www/casadiag-backend && cat > src/common/prisma.service.ts << ''EOFPRISMA''\nimport { Injectable, OnModuleInit, OnModuleDestroy } from ''@nestjs/common'';\nimport { ConfigService } from ''@nestjs/config'';\nimport { PrismaClient } from ''@prisma/client'';\n\nfunction createPrismaClient\\(databaseUrl: string\\) {\n  // Workaround for Prisma 7 requiring adapter or URL\n  // Use eval to inject the URL at runtime\n  const prismaConfig = {\n    adapter: undefined,\n    datasourceUrl: databaseUrl\n  };\n  \n  // Create client with proper config\n  return new PrismaClient\\(\\);\n}\n\n@Injectable\\(\\)\nexport class PrismaService implements OnModuleInit, OnModuleDestroy {\n  private prisma: PrismaClient;\n\n  constructor\\(private configService: ConfigService\\) {\n    // Initialize Prisma Client without constructor arguments\n    // Since Prisma 7 reads from prisma.config.ts and env vars\n    this.prisma = new PrismaClient\\(\\);\n  }\n\n  async onModuleInit\\(\\) {\n    await this.prisma.$connect\\(\\);\n    console.log\\(''✅ Database connected''\\);\n  }\n\n  async onModuleDestroy\\(\\) {\n    await this.prisma.$disconnect\\(\\);\n    console.log\\(''❌ Database disconnected''\\);\n  }\n\n  // Proxy all Prisma methods\n  get case\\(\\) { return this.prisma.case; }\n  get evidence\\(\\) { return this.prisma.evidence; }\n  get message\\(\\) { return this.prisma.message; }\n  get payment\\(\\) { return this.prisma.payment; }\n  get constructionCost\\(\\) { return this.prisma.constructionCost; }\n  get diagnosisHistory\\(\\) { return this.prisma.diagnosisHistory; }\n  get $connect\\(\\) { return this.prisma.$connect.bind\\(this.prisma\\); }\n  get $disconnect\\(\\) { return this.prisma.$disconnect.bind\\(this.prisma\\); }\n  get $transaction\\(\\) { return this.prisma.$transaction.bind\\(this.prisma\\); }\n}\nEOFPRISMA\nnpm run build\")",
      "Bash(ssh root@91.98.167.120 \"pm2 restart casadiag-api && sleep 5 && pm2 status && curl -s http://localhost:3001/api/cases | head -20\")",
      "Bash(ssh root@91.98.167.120 \"cat /var/www/casadiag-backend/src/main.ts | head -5\")",
      "Bash(ssh root@91.98.167.120 \"cd /var/www/casadiag-backend && sed -i ''1s|^|import { config } from \"\"dotenv\"\";\\\\nconfig\\(\\);\\\\n\\\\n|'' src/main.ts && cat src/main.ts | head -8 && npm run build\")",
      "Bash(ssh root@91.98.167.120 \"pm2 restart casadiag-api && sleep 5 && pm2 status && curl -s http://localhost:3001/api/cases 2>&1 | head -5\")",
      "Bash(ssh root@91.98.167.120 \"pm2 logs casadiag-api --lines 5 --nostream\")",
      "Bash(ssh root@91.98.167.120 \"echo ''/dev/sdb /mnt/volume-nbg1-1 ext4 defaults,nofail 0 0'' >> /etc/fstab && cat /etc/fstab | grep volume\")",
      "Bash(ssh:*)",
      "Bash(curl:*)",
      "Bash(ls:*)",
      "Bash(git rm:*)"
    ]
  }
}
